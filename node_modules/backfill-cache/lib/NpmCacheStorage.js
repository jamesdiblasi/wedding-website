"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.NpmCacheStorage = void 0;
const path_1 = __importDefault(require("path"));
const execa_1 = __importDefault(require("execa"));
const fs_extra_1 = __importDefault(require("fs-extra"));
const globby_1 = __importDefault(require("globby"));
const CacheStorage_1 = require("./CacheStorage");
class NpmCacheStorage extends CacheStorage_1.CacheStorage {
    constructor(options, internalCacheFolder, logger, cwd, incrementalCaching = false) {
        super(logger, cwd, incrementalCaching);
        this.options = options;
        this.internalCacheFolder = internalCacheFolder;
    }
    async _fetch(hash) {
        const { npmPackageName, registryUrl, npmrcUserconfig } = this.options;
        const temporaryNpmOutputFolder = path_1.default.resolve(this.cwd, this.internalCacheFolder, "npm", hash);
        const packageFolderInTemporaryFolder = path_1.default.join(temporaryNpmOutputFolder, "node_modules", npmPackageName);
        if (!fs_extra_1.default.existsSync(packageFolderInTemporaryFolder)) {
            fs_extra_1.default.mkdirpSync(temporaryNpmOutputFolder);
            try {
                const runner = execa_1.default("npm", [
                    "install",
                    "--prefix",
                    temporaryNpmOutputFolder,
                    `${npmPackageName}@0.0.0-${hash}`,
                    "--registry",
                    registryUrl,
                    "--prefer-offline",
                    "--ignore-scripts",
                    "--no-shrinkwrap",
                    "--no-package-lock",
                    "--loglevel",
                    "error",
                    ...(npmrcUserconfig ? ["--userconfig", npmrcUserconfig] : []),
                ]);
                this.logger.pipeProcessOutput(runner.stdout, runner.stderr);
                await runner;
            }
            catch (error) {
                fs_extra_1.default.removeSync(temporaryNpmOutputFolder);
                if (error.stderr.toString().indexOf("ETARGET") > -1) {
                    return false;
                }
                else {
                    throw new Error(error);
                }
            }
        }
        const files = await globby_1.default(`**/*`, {
            cwd: packageFolderInTemporaryFolder,
        });
        await Promise.all(files.map(async (file) => {
            await fs_extra_1.default.mkdirp(path_1.default.dirname(path_1.default.join(this.cwd, file)));
            await fs_extra_1.default.copy(path_1.default.join(packageFolderInTemporaryFolder, file), path_1.default.join(this.cwd, file));
        }));
        return true;
    }
    async _put(hash, filesToCache) {
        const { npmPackageName, registryUrl, npmrcUserconfig } = this.options;
        const temporaryNpmOutputFolder = path_1.default.resolve(this.cwd, this.internalCacheFolder, "npm", hash, "upload");
        // Create package.json file
        fs_extra_1.default.outputJSONSync(path_1.default.join(temporaryNpmOutputFolder, "package.json"), {
            name: npmPackageName,
            version: `0.0.0-${hash}`,
        });
        await fs_extra_1.default.mkdirp(temporaryNpmOutputFolder);
        await Promise.all(filesToCache.map(async (file) => {
            const destinationFolder = path_1.default.join(temporaryNpmOutputFolder, path_1.default.dirname(file));
            await fs_extra_1.default.mkdirp(destinationFolder);
            await fs_extra_1.default.copy(path_1.default.join(this.cwd, file), path_1.default.join(temporaryNpmOutputFolder, file));
        }));
        // Upload package
        try {
            const runner = execa_1.default("npm", [
                "publish",
                "--registry",
                registryUrl,
                "--loglevel",
                "error",
                ...(npmrcUserconfig ? ["--userconfig", npmrcUserconfig] : []),
            ], {
                cwd: temporaryNpmOutputFolder,
                stdout: "inherit",
            });
            this.logger.pipeProcessOutput(runner.stdout, runner.stderr);
            await runner;
        }
        catch (error) {
            if (error.stderr.toString().indexOf("403") === -1) {
                throw new Error(error);
            }
        }
    }
}
exports.NpmCacheStorage = NpmCacheStorage;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTnBtQ2FjaGVTdG9yYWdlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL05wbUNhY2hlU3RvcmFnZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxnREFBd0I7QUFDeEIsa0RBQTBCO0FBQzFCLHdEQUEwQjtBQUMxQixvREFBNEI7QUFLNUIsaURBQThDO0FBRTlDLE1BQWEsZUFBZ0IsU0FBUSwyQkFBWTtJQUMvQyxZQUNVLE9BQStCLEVBQy9CLG1CQUEyQixFQUNuQyxNQUFjLEVBQ2QsR0FBVyxFQUNYLGtCQUFrQixHQUFHLEtBQUs7UUFFMUIsS0FBSyxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztRQU4vQixZQUFPLEdBQVAsT0FBTyxDQUF3QjtRQUMvQix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQVE7SUFNckMsQ0FBQztJQUVTLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBWTtRQUNqQyxNQUFNLEVBQUUsY0FBYyxFQUFFLFdBQVcsRUFBRSxlQUFlLEVBQUUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBRXRFLE1BQU0sd0JBQXdCLEdBQUcsY0FBSSxDQUFDLE9BQU8sQ0FDM0MsSUFBSSxDQUFDLEdBQUcsRUFDUixJQUFJLENBQUMsbUJBQW1CLEVBQ3hCLEtBQUssRUFDTCxJQUFJLENBQ0wsQ0FBQztRQUVGLE1BQU0sOEJBQThCLEdBQUcsY0FBSSxDQUFDLElBQUksQ0FDOUMsd0JBQXdCLEVBQ3hCLGNBQWMsRUFDZCxjQUFjLENBQ2YsQ0FBQztRQUVGLElBQUksQ0FBQyxrQkFBRSxDQUFDLFVBQVUsQ0FBQyw4QkFBOEIsQ0FBQyxFQUFFO1lBQ2xELGtCQUFFLENBQUMsVUFBVSxDQUFDLHdCQUF3QixDQUFDLENBQUM7WUFFeEMsSUFBSTtnQkFDRixNQUFNLE1BQU0sR0FBRyxlQUFLLENBQUMsS0FBSyxFQUFFO29CQUMxQixTQUFTO29CQUNULFVBQVU7b0JBQ1Ysd0JBQXdCO29CQUN4QixH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