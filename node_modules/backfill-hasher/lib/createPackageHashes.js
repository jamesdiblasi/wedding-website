"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.createPackageHashes = void 0;
const path_1 = __importDefault(require("path"));
function createPackageHashes(root, workspaceInfo, repoHashes) {
    const pathTree = {};
    // Generate path tree of all packages in workspace (scale: ~2000 * ~3)
    for (const workspace of workspaceInfo) {
        const pathParts = path_1.default.relative(root, workspace.path).split(/[\\/]/);
        let currentNode = pathTree;
        for (const part of pathParts) {
            currentNode[part] = currentNode[part] || {};
            currentNode = currentNode[part];
        }
    }
    // key: path/to/package (packageRoot), value: array of a tuple of [file, hash]
    const packageHashes = {};
    for (const [entry, value] of Object.entries(repoHashes)) {
        const pathParts = entry.split(/[\\/]/);
        let node = pathTree;
        let packagePathParts = [];
        for (const part of pathParts) {
            if (node[part]) {
                node = node[part];
                packagePathParts.push(part);
            }
            else {
                break;
            }
        }
        const packageRoot = packagePathParts.join("/");
        packageHashes[packageRoot] = packageHashes[packageRoot] || [];
        packageHashes[packageRoot].push([entry, value]);
    }
    return packageHashes;
}
exports.createPackageHashes = createPackageHashes;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlUGFja2FnZUhhc2hlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9jcmVhdGVQYWNrYWdlSGFzaGVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLGdEQUF3QjtBQUd4QixTQUFnQixtQkFBbUIsQ0FDakMsSUFBWSxFQUNaLGFBQTRCLEVBQzVCLFVBQXFDO0lBZ0JyQyxNQUFNLFFBQVEsR0FBYSxFQUFFLENBQUM7SUFFOUIsc0VBQXNFO0lBQ3RFLEtBQUssTUFBTSxTQUFTLElBQUksYUFBYSxFQUFFO1FBQ3JDLE1BQU0sU0FBUyxHQUFHLGNBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFckUsSUFBSSxXQUFXLEdBQUcsUUFBUSxDQUFDO1FBRTNCLEtBQUssTUFBTSxJQUFJLElBQUksU0FBUyxFQUFFO1lBQzVCLFdBQVcsQ0FBQyxJQUFJLENBQUMsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQzVDLFdBQVcsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDakM7S0FDRjtJQUVELDhFQUE4RTtJQUM5RSxNQUFNLGFBQWEsR0FBdUMsRUFBRSxDQUFDO0lBRTdELEtBQUssTUFBTSxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxFQUFFO1FBQ3ZELE1BQU0sU0FBUyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFdkMsSUFBSSxJQUFJLEdBQUcsUUFBUSxDQUFDO1FBQ3BCLElBQUksZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO1FBRTFCLEtBQUssTUFBTSxJQUFJLElBQUksU0FBUyxFQUFFO1lBQzVCLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUNkLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFhLENBQUM7Z0JBQzlCLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUM3QjtpQkFBTTtnQkFDTCxNQUFNO2FBQ1A7U0FDRjtRQUVELE1BQU0sV0FBVyxHQUFHLGdCQUFnQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMvQyxhQUFhLENBQUMsV0FBVyxDQUFDLEdBQUcsYUFBYSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUM5RCxhQUFhLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7S0FDakQ7SUFFRCxPQUFPLGFBQWEsQ0FBQztBQUN2QixDQUFDO0FBekRELGtEQXlEQyJ9